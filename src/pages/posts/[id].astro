---
import Layout from "../../layouts/Layout.astro";
import { marked } from 'marked';
import hljs from 'highlight.js';

export const prerender = false;

const { id } = Astro.params;
const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:3000';

let post;
let error = null;
let htmlContent = '';

try {
  const res = await fetch(`${API_BASE}/api/posts/${id}`).catch(() => null);
  
  if (res?.ok) {
    post = await res.json();
    
    // Configure marked with highlight.js
    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true
    });

    if (post?.content) {
      htmlContent = marked.parse(post.content);
    }
  } else {
    throw new Error('Post not found or API unreachable');
  }
} catch (e) {
  error = e.message;
}

const formattedDate = post?.created_at 
  ? new Date(post.created_at).toLocaleDateString('en-US', {
      month: 'long', day: 'numeric', year: 'numeric'
    }) 
  : '';

// Generate a clean excerpt for SEO
const seoDescription = post?.content 
  ? post.content.replace(/[#*`]/g, '').substring(0, 160).trim() + '...'
  : '';
---

<Layout title={post?.title ?? "Post"} description={seoDescription}>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  
  <div class="container" data-post-id={id} data-api-base={API_BASE} data-title={post?.title} data-excerpt={post?.content ? post.content.replace(/[#*`]/g, '').substring(0, 220).trim() : ''} data-likes={post?.likes || 0} data-image={post?.image || ''}>
    {error || !post ? (
      <div class="error-message">
        {error ?? 'This post could not be loaded.'}
      </div>
    ) : (
      <article class="post">
        <header class="post-header">
          <a href="/" class="back-link">&larr; Back to Home</a>
          
          {post.categories?.length > 0 && (
            <div class="categories">
              {post.categories.map(cat => (
                <a href={`/categories/${cat.slug}`} class="category-tag">
                  {cat.name}
                </a>
              ))}
            </div>
          )}
          
          <h1 class="post-title">{post.title}</h1>
          
          <div class="post-meta flex items-center gap-4">
            <time>{formattedDate}</time>
            <span class="text-gray-300 dark:text-gray-600">|</span>
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
              <span id="view-count">{post.views || 0} views</span>
            </span>

            <span class="flex items-center gap-3">
              <button id="like-btn" class="like-btn flex items-center gap-2 px-3 py-1 bg-transparent border border-gray-300 rounded-md hover:bg-gray-100">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                <span id="like-count">{post?.likes || 0}</span>
              </button>

              <button id="share-btn" class="share-btn flex items-center gap-2 px-3 py-1 bg-transparent border border-gray-300 rounded-md hover:bg-gray-100">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7l4-4 4 4"/></svg>
                <span>Share</span>
              </button>
            </span>
          </div>
        </header>

        <div id="post-content" class="post-content prose" set:html={htmlContent}>
        </div>
      </article>
    )}
  </div>

  <script>
    // Increment view count on load
    const container = document.querySelector('.container');
    const postId = container?.getAttribute('data-post-id');
    const apiBase = container?.getAttribute('data-api-base');

    if (postId && apiBase) {
      fetch(`${apiBase}/api/posts/${postId}/view`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const viewCountEl = document.getElementById('view-count');
            if (viewCountEl) viewCountEl.textContent = `${data.views} views`;
          }
        })
        .catch(err => console.error('Failed to increment view count:', err));
    }

    // Add Copy buttons to code blocks
    document.querySelectorAll('pre').forEach((pre) => {
      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper relative group my-8';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // Create header
      const header = document.createElement('div');
      header.className = 'code-header flex items-center justify-between px-4 py-2 bg-[#2d2d2d] text-gray-400 text-xs rounded-t-lg border-b border-gray-700/50';
      const lang = pre.querySelector('code')?.className.replace('language-', '') || 'code';
      header.innerHTML = `<span class="uppercase tracking-wider font-semibold">${lang}</span>`;
      
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn hover:text-white transition-colors flex items-center gap-1 cursor-pointer';
      copyBtn.innerHTML = `
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
        <span>Copy</span>
      `;
      
      copyBtn.addEventListener('click', () => {
        const code = pre.querySelector('code')?.innerText || '';
        navigator.clipboard.writeText(code).then(() => {
          copyBtn.innerHTML = `<span>Copied!</span>`;
          setTimeout(() => {
            copyBtn.innerHTML = `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><span>Copy</span>`;
          }, 2000);
        });
      });

      header.appendChild(copyBtn);
      wrapper.insertBefore(header, pre);
      pre.classList.add('!mt-0', '!rounded-t-none');
    });

    // Like button logic
    const likeBtn = document.getElementById('like-btn');
    const likeCountEl = document.getElementById('like-count');
    if (likeBtn) {
      likeBtn.addEventListener('click', () => {
        if (!postId || !apiBase) return;
        fetch(`${apiBase}/api/posts/${postId}/like`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            if (data && typeof data.likes !== 'undefined') {
              likeCountEl.textContent = data.likes;
            }
          })
          .catch(err => console.error('Failed to like post:', err));
      });
    }

    // Share button logic: try native share, otherwise show preview modal
    const shareBtn = document.getElementById('share-btn');
    const containerEl = document.querySelector('.container');
    if (shareBtn && containerEl) {
      shareBtn.addEventListener('click', async () => {
        const title = containerEl.getAttribute('data-title') || document.title;
        const excerpt = containerEl.getAttribute('data-excerpt') || '';
        const image = containerEl.getAttribute('data-image') || '';
        const url = window.location.href;

        const shareData = { title, text: excerpt, url };

        if (navigator.share) {
          try {
            await navigator.share(shareData);
            return;
          } catch (err) {
            console.warn('Native share failed, falling back to preview', err);
          }
        }

        // Fallback: populate and show preview modal
        const preview = document.getElementById('share-preview');
        if (preview) {
          preview.querySelector('.preview-title').textContent = title;
          preview.querySelector('.preview-excerpt').textContent = excerpt;
          const imgEl = preview.querySelector('.preview-image');
          if (image) {
            imgEl.src = image;
            imgEl.style.display = 'block';
          } else {
            imgEl.style.display = 'none';
          }
          preview.querySelector('.preview-link').textContent = url;
          preview.querySelector('.preview-link').href = url;
          preview.classList.remove('hidden');
        }
      });
    }

    // Modal actions: copy link and close
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (target.matches('#copy-link-btn')) {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          target.textContent = 'Copied!';
          setTimeout(() => target.textContent = 'Copy link', 1500);
        });
      }
      if (target.matches('#close-preview-btn') || target.matches('#share-preview')) {
        const preview = document.getElementById('share-preview');
        if (preview) preview.classList.add('hidden');
      }
    });
  </script>

  <!-- Share preview modal (fallback when navigator.share not available) -->
  <div id="share-preview" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60" role="dialog">
    <div class="bg-black text-white rounded-lg max-w-xl w-full mx-4 overflow-hidden border border-gray-800">
      <div class="p-4 border-b border-gray-800 flex items-start justify-between">
        <h3 class="font-semibold">Share post</h3>
        <button id="close-preview-btn" class="text-gray-300 hover:text-white">âœ•</button>
      </div>
      <div class="p-4 flex gap-4 items-start">
        <img class="preview-image w-28 h-20 object-cover rounded-md" src="" alt="" style="display:none; background:#111" />
        <div class="flex-1">
          <div class="preview-title font-bold text-lg"></div>
          <div class="preview-excerpt text-sm text-gray-300 mt-2"></div>
          <a class="preview-link text-xs text-blue-300 break-words block mt-2" href="#"></a>
        </div>
      </div>
      <div class="p-4 border-t border-gray-800 flex items-center justify-end gap-2">
        <button id="copy-link-btn" class="px-3 py-1 border border-gray-600 rounded text-white bg-transparent hover:bg-white/10">Copy link</button>
        <a class="px-3 py-1 bg-white/10 text-white rounded hover:bg-white/20" href="#" id="open-share-link" target="_blank">Open Link</a>
      </div>
    </div>
  </div>
</Layout>

<style>
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 4rem 2rem;
  }

  .post-header {
    margin-bottom: 3.5rem;
  }

  .back-link {
    display: inline-block;
    color: var(--color-primary);
    text-decoration: none;
    margin-bottom: 2rem;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }

  .back-link:hover {
    color: var(--color-primary-dark);
    transform: translateX(-4px);
  }

  .categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .category-tag {
    display: inline-block;
    padding: 0.4rem 1rem;
    background: var(--color-gray-100);
    color: var(--color-gray-700);
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: 1px solid var(--color-gray-200);
  }

  .category-tag:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }

  .post-title {
    font-size:clamp(2.5rem, 5vw, 3.5rem);
    font-weight: 800;
    color: var(--text-heading);
    line-height: 1.1;
    margin-bottom: 1.5rem;
    letter-spacing: -0.02em;
  }

  .post-meta {
    color: var(--color-gray-500);
    font-size: 0.95rem;
    font-family: var(--font-sans);
  }

  .post-content {
    color: var(--text-main);
    line-height: 1.8;
    font-size: 1.125rem;
  }

  /* Prose styles for markdown content */
  .prose {
    max-width: none;
  }

  .prose :global(h1) {
    font-size: 2.25em;
    margin-top: 2em;
    margin-bottom: 1em;
    font-weight: 800;
    color: var(--text-heading);
  }

  .prose :global(h2) {
    font-size: 1.875em;
    margin-top: 2em;
    margin-bottom: 1em;
    font-weight: 700;
    color: var(--text-heading);
  }

  .prose :global(h3) {
    font-size: 1.5em;
    margin-top: 1.8em;
    margin-bottom: 0.8em;
    font-weight: 600;
    color: var(--text-heading);
  }

  .prose :global(p) {
    margin-top: 1.5em;
    margin-bottom: 1.5em;
  }

  .prose :global(pre) {
    background-color: #1e1e1e !important;
    border-radius: 0.5rem;
    padding: 1.5rem;
    overflow-x: auto;
    margin: 0;
    border: none;
    color: #e4e4e7 !important;
  }

  .prose :global(code) {
    background-color: var(--color-gray-100);
    color: var(--color-primary-dark);
    padding: 0.2em 0.4em;
    border-radius: 0.375rem;
    font-size: 0.9em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .prose :global(pre code) {
    background-color: transparent;
    padding: 0;
    color: inherit;
    font-size: 0.95rem;
    line-height: 1.7;
  }

  .prose :global(ul), .prose :global(ol) {
    margin-top: 1.5em;
    margin-bottom: 1.5em;
    padding-left: 1.5em;
  }

  .prose :global(li) {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }

  .prose :global(blockquote) {
    font-style: italic;
    border-left: 4px solid var(--color-primary);
    padding: 0.5rem 0 0.5rem 1.5rem;
    margin: 2rem 0;
    color: var(--color-gray-600);
    background: var(--color-gray-50);
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .prose :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 4px;
    transition: all 0.2s ease;
  }

  .prose :global(a:hover) {
    color: var(--color-primary-dark);
    background: var(--color-primary);
    color: white;
    text-decoration: none;
    padding: 0 2px;
    border-radius: 2px;
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 1rem;
    margin: 2.5rem 0;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 2.5rem 0;
    border: 1px solid var(--color-gray-200);
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .prose :global(th), .prose :global(td) {
    border-bottom: 1px solid var(--color-gray-200);
    border-right: 1px solid var(--color-gray-200);
    padding: 1rem;
    text-align: left;
  }

  .prose :global(th:last-child), .prose :global(td:last-child) {
    border-right: none;
  }

  .prose :global(tr:last-child td) {
    border-bottom: none;
  }

  .prose :global(th) {
    background-color: var(--color-gray-50);
    font-weight: 700;
    color: var(--text-heading);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--color-gray-200);
    margin: 4rem 0;
  }

  .error-message {
    text-align: center;
    padding: 4rem 2rem;
    color: #ef4444;
    background: #fef2f2;
    border-radius: 1rem;
    border: 1px solid #fee2e2;
  }

  @media (max-width: 768px) {
    .container {
      padding: 2rem 1.5rem;
    }
    
    .post-header {
      margin-bottom: 2rem;
    }

    .prose :global(h1) { font-size: 1.875em; }
    .prose :global(h2) { font-size: 1.5em; }
  }
</style>

  <style>
    /* Simple styles for share modal and buttons */
    #share-preview.hidden { display: none; }
    #share-preview img.preview-image { background: #f3f4f6; }
    .like-btn { min-width: 56px; }
    .share-btn { min-width: 72px; }
    .bg-primary { background-color: var(--color-primary); }
  </style>