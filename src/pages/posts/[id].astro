---
import Layout from "../../layouts/Layout.astro";

export const prerender = false;

const { id } = Astro.params;
const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:3000';

let post;
let error = null;

try {
  const res = await fetch(`${API_BASE}/api/posts/${id}`);
  if (!res.ok) throw new Error('Post not found');
  post = await res.json();
} catch (e) {
  error = e.message;
}

const formattedDate = post?.created_at 
  ? new Date(post.created_at).toLocaleDateString('en-US', {
      month: 'long', day: 'numeric', year: 'numeric'
    }) 
  : '';
---

<Layout title={post?.title ?? "Post"}>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  
  <div class="container">
    {error || !post ? (
      <div class="error-message">
        {error ?? 'This post could not be loaded.'}
      </div>
    ) : (
      <article class="post">
        <header class="post-header">
          <a href="/posts" class="back-link">&larr; All Posts</a>
          
          {post.categories?.length > 0 && (
            <div class="categories">
              {post.categories.map(cat => (
                <a href={`/categories/${cat.slug}`} class="category-tag">
                  {cat.name}
                </a>
              ))}
            </div>
          )}
          
          <h1 class="post-title">{post.title}</h1>
          
          <div class="post-meta">
            <time>{formattedDate}</time>
          </div>
        </header>

        <div id="post-content" class="post-content prose">
          {post.content}
        </div>
      </article>
    )}
  </div>

  <script>
    // Load marked and highlight.js
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    (async function() {
      const contentEl = document.getElementById('post-content');
      if (!contentEl) return;

      const markdown = contentEl.textContent;

      await loadScript('https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js');
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js');

      marked.setOptions({
        highlight: function(code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true
      });

      contentEl.innerHTML = marked.parse(markdown);
    })();
  </script>
</Layout>

<style>
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 4rem 2rem;
  }

  .post-header {
    margin-bottom: 3rem;
  }

  .back-link {
    display: inline-block;
    color: #667eea;
    text-decoration: none;
    margin-bottom: 1.5rem;
    font-weight: 600;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: #764ba2;
  }

  .categories {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .category-tag {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    background: #f3f4f6;
    color: #374151;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .category-tag:hover {
    background: #667eea;
    color: white;
  }

  .post-title {
    font-size: 3rem;
    font-weight: 800;
    color: #1f2937;
    line-height: 1.2;
    margin-bottom: 1rem;
  }

  .post-meta {
    color: #6b7280;
    font-size: 1rem;
  }

  .post-content {
    color: #1f2937;
    line-height: 1.8;
  }

  /* Prose styles for markdown content */
  .prose {
    max-width: none;
  }

  .prose :global(h1) {
    font-size: 2.25em;
    margin-top: 0;
    margin-bottom: 0.8888889em;
    line-height: 1.1111111;
    font-weight: 800;
    color: #1f2937;
  }

  .prose :global(h2) {
    font-size: 1.875em;
    margin-top: 2em;
    margin-bottom: 1em;
    line-height: 1.3333333;
    font-weight: 700;
    color: #1f2937;
  }

  .prose :global(h3) {
    font-size: 1.5em;
    margin-top: 1.6em;
    margin-bottom: 0.6em;
    line-height: 1.6;
    font-weight: 600;
    color: #1f2937;
  }

  .prose :global(p) {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    font-size: 1.125rem;
  }

  .prose :global(pre) {
    background-color: #1f2937;
    border-radius: 0.5rem;
    padding: 1.25rem;
    overflow-x: auto;
    margin: 1.75em 0;
  }

  .prose :global(code) {
    background-color: #f3f4f6;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.875em;
    color: #e11d48;
    font-family: 'Courier New', monospace;
  }

  .prose :global(pre code) {
    background-color: transparent;
    padding: 0;
    color: inherit;
  }

  .prose :global(ul), .prose :global(ol) {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    padding-left: 1.625em;
  }

  .prose :global(li) {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }

  .prose :global(blockquote) {
    font-style: italic;
    border-left: 4px solid #667eea;
    padding-left: 1em;
    margin: 1.75em 0;
    color: #4b5563;
    font-size: 1.125rem;
  }

  .prose :global(a) {
    color: #667eea;
    text-decoration: underline;
    transition: color 0.3s ease;
  }

  .prose :global(a:hover) {
    color: #764ba2;
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.75rem;
    margin: 2em 0;
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2em 0;
  }

  .prose :global(th), .prose :global(td) {
    border: 1px solid #e5e7eb;
    padding: 0.75em;
    text-align: left;
  }

  .prose :global(th) {
    background-color: #f9fafb;
    font-weight: 600;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 3em 0;
  }

  .error-message {
    text-align: center;
    padding: 4rem 2rem;
    color: #dc2626;
  }

  @media (max-width: 768px) {
    .post-title {
      font-size: 2rem;
    }

    .prose :global(h1) {
      font-size: 1.875em;
    }

    .prose :global(h2) {
      font-size: 1.5em;
    }
  }
</style>