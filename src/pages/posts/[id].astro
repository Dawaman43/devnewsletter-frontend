---
import PostLayout from "../../layouts/PostLayout.astro";

export const prerender = false;

const { id } = Astro.params;
const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:3000';

let post;
let error = null;

try {
  const res = await fetch(`${API_BASE}/posts/${id}`);
  if (!res.ok) throw new Error('Post not found');
  post = await res.json();
} catch (e) {
  error = e.message;
}


const formattedDate = post?.created_at 
  ? new Date(post.created_at).toLocaleDateString('en-US', {
      month: 'long', day: 'numeric', year: 'numeric'
    }) 
  : '';
---

<PostLayout 
  title={post?.title ?? "Loading..."} 
  description={post?.excerpt ?? "Read more about this post."}
  pubDate={formattedDate}
  heroImage={post?.cover_image}
>
  {error || !post ? (
    <div class="rounded-xl bg-red-50 border border-red-100 p-6 text-red-700">
      {error ?? 'This post could not be loaded.'}
    </div>
  ) : (
    <>
      
      {post.categories?.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-8">
          {post.categories.map(cat => (
            <span class="text-xs font-sans uppercase tracking-widest bg-amber-100 px-3 py-1 rounded-full text-amber-900">
              {cat.name}
            </span>
          ))}
        </div>
      )}

  
      <article class="post-content">
        <div set:html={post.content}></div>
      </article>
    </>
  )}
</PostLayout>