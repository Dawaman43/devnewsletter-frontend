---
import AdminLayout from "../../layouts/AdminLayout.astro";
export const prerender = true;

const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:3000';
---

<AdminLayout title="Dashboard">
  <div>
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Dashboard</h1>
    
    <div id="stats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-sm text-gray-600 mb-1">Total Posts</div>
        <div class="text-3xl font-bold text-gray-900" id="totalPosts">-</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-sm text-gray-600 mb-1">Published</div>
        <div class="text-3xl font-bold text-green-600" id="publishedPosts">-</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="text-sm text-gray-600 mb-1">Categories</div>
        <div class="text-3xl font-bold text-blue-600" id="totalCategories">-</div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Recent Posts</h2>
      </div>
      <div id="recentPosts" class="divide-y divide-gray-200">
        <div class="p-6 text-gray-500">Loading...</div>
      </div>
    </div>
  </div>

  <script define:vars={{ API_BASE }}>
    (async function(){
      const getToken = () => {
        try { const t = localStorage.getItem('token'); if (t) return t; } catch(e) {}
        const m = document.cookie.match(/(?:^|; )token=([^;]+)/);
        if (m) return decodeURIComponent(m[1]);
        return null;
      };

      const token = getToken();
      if (!token) return;

      try {
        // Fetch posts
        const postsRes = await fetch(`${API_BASE}/admin/posts`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!postsRes.ok) {
          if (postsRes.status === 401) return window.location.href = '/admin/login';
          throw new Error('Failed to fetch posts: ' + postsRes.status);
        }
        const postsJson = await postsRes.json();
        const posts = Array.isArray(postsJson) ? postsJson : [];

        // Fetch categories
        const catsRes = await fetch(`${API_BASE}/admin/categories`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!catsRes.ok) {
          if (catsRes.status === 401) return window.location.href = '/admin/login';
          throw new Error('Failed to fetch categories: ' + catsRes.status);
        }
        const catsJson = await catsRes.json();
        const categories = Array.isArray(catsJson) ? catsJson : [];

        // Update stats
        document.getElementById('totalPosts').textContent = posts.length;
        document.getElementById('publishedPosts').textContent = (Array.isArray(posts) ? posts.filter(p => p.published).length : 0);
        document.getElementById('totalCategories').textContent = categories.length;

        // Show recent posts
        const recentPostsEl = document.getElementById('recentPosts');
        if (posts.length === 0) {
          recentPostsEl.innerHTML = '<div class="p-6 text-gray-500">No posts yet</div>';
        } else {
          recentPostsEl.innerHTML = posts.slice(0, 5).map(post => `
            <div class="p-6 hover:bg-gray-50">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-medium text-gray-900">${post.title}</h3>
                  <p class="text-sm text-gray-500 mt-1">
                    ${new Date(post.created_at).toLocaleDateString()}
                    ${post.published ? '<span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Published</span>' : '<span class="ml-2 px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">Draft</span>'}
                  </p>
                </div>
                <a href="/admin/posts/${post.id}" class="text-blue-600 hover:text-blue-800">Edit</a>
              </div>
            </div>
          `).join('');
        }
      } catch (err) {
        console.error('Failed to load dashboard data', err);
      }
    })();
  </script>
</AdminLayout>
