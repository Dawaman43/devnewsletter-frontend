---
import AdminLayout from "../../../layouts/AdminLayout.astro";
export const prerender = true;

const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:3000';
---

<AdminLayout title="Categories">
  <div>
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Categories</h1>

    <!-- Create new category form -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Add New Category</h2>
      <form id="createForm" class="flex gap-4">
        <div class="flex-1">
          <input 
            type="text" 
            id="newName" 
            placeholder="Category name"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div class="flex-1">
          <input 
            type="text" 
            id="newSlug" 
            placeholder="slug-name"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <button 
          type="submit" 
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          Add Category
        </button>
      </form>
    </div>

    <!-- Categories list -->
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">All Categories</h2>
      </div>
      <div id="categoriesTable" class="divide-y divide-gray-200">
        <div class="p-6 text-gray-500">Loading...</div>
      </div>
    </div>
  </div>

  <script define:vars={{ API_BASE }}>
    (async function(){
      const getToken = () => {
        try { const t = localStorage.getItem('token'); if (t) return t; } catch(e) {}
        const m = document.cookie.match(/(?:^|; )token=([^;]+)/);
        if (m) return decodeURIComponent(m[1]);
        return null;
      };

      const token = getToken();
      if (!token) return;

      let categories = [];
      let editingId = null;

      async function loadCategories() {
        try {
          const res = await fetch(`${API_BASE}/admin/categories`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          categories = await res.json();
          renderCategories();
        } catch (err) {
          console.error('Failed to load categories', err);
          document.getElementById('categoriesTable').innerHTML = '<div class="p-6 text-red-500">Failed to load categories</div>';
        }
      }

      function renderCategories() {
        const table = document.getElementById('categoriesTable');
        if (categories.length === 0) {
          table.innerHTML = '<div class="p-6 text-gray-500">No categories yet</div>';
          return;
        }

        table.innerHTML = categories.map(cat => `
          <div class="p-6 hover:bg-gray-50" data-id="${cat.id}">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="edit-view-${cat.id}">
                  <h3 class="font-medium text-gray-900">${cat.name}</h3>
                  <p class="text-sm text-gray-500 mt-1">${cat.slug}</p>
                </div>
                <div class="edit-form-${cat.id} hidden">
                  <div class="flex gap-4">
                    <input 
                      type="text" 
                      class="edit-name flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                      value="${cat.name}"
                    />
                    <input 
                      type="text" 
                      class="edit-slug flex-1 px-3 py-2 border border-gray-300 rounded-lg"
                      value="${cat.slug}"
                    />
                  </div>
                </div>
              </div>
              <div class="flex gap-2">
                <div class="edit-actions-${cat.id}">
                  <button class="edit-btn px-3 py-1 text-sm text-blue-600 hover:text-blue-800" data-id="${cat.id}">Edit</button>
                  <button class="delete-btn px-3 py-1 text-sm text-red-600 hover:text-red-800" data-id="${cat.id}">Delete</button>
                </div>
                <div class="save-actions-${cat.id} hidden">
                  <button class="save-btn px-3 py-1 text-sm text-green-600 hover:text-green-800" data-id="${cat.id}">Save</button>
                  <button class="cancel-btn px-3 py-1 text-sm text-gray-600 hover:text-gray-800" data-id="${cat.id}">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');

        attachEventHandlers();
      }

      function attachEventHandlers() {
        // Edit buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            document.querySelector(`.edit-view-${id}`).classList.add('hidden');
            document.querySelector(`.edit-form-${id}`).classList.remove('hidden');
            document.querySelector(`.edit-actions-${id}`).classList.add('hidden');
            document.querySelector(`.save-actions-${id}`).classList.remove('hidden');
          });
        });

        // Cancel buttons
        document.querySelectorAll('.cancel-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            document.querySelector(`.edit-view-${id}`).classList.remove('hidden');
            document.querySelector(`.edit-form-${id}`).classList.add('hidden');
            document.querySelector(`.edit-actions-${id}`).classList.remove('hidden');
            document.querySelector(`.save-actions-${id}`).classList.add('hidden');
          });
        });

        // Save buttons
        document.querySelectorAll('.save-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const name = document.querySelector(`.edit-form-${id} .edit-name`).value;
            const slug = document.querySelector(`.edit-form-${id} .edit-slug`).value;

            try {
              await fetch(`${API_BASE}/admin/categories/${id}`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ name, slug })
              });
              await loadCategories();
            } catch (err) {
              alert('Failed to update category');
            }
          });
        });

        // Delete buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!confirm('Are you sure you want to delete this category?')) return;
            
            try {
              await fetch(`${API_BASE}/admin/categories/${id}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${token}` }
              });
              await loadCategories();
            } catch (err) {
              alert('Failed to delete category');
            }
          });
        });
      }

      // Create form
      document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('newName').value;
        const slug = document.getElementById('newSlug').value;

        try {
          await fetch(`${API_BASE}/admin/categories`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({ name, slug })
          });
          
          document.getElementById('newName').value = '';
          document.getElementById('newSlug').value = '';
          await loadCategories();
        } catch (err) {
          alert('Failed to create category');
        }
      });

      // Auto-generate slug from name
      document.getElementById('newName').addEventListener('input', (e) => {
        const slug = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        document.getElementById('newSlug').value = slug;
      });

      await loadCategories();
    })();
  </script>
</AdminLayout>
