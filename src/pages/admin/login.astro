---
import Layout from "../../layouts/Layout.astro";
export const prerender = true;
---

<Layout title="Admin Login — DevNewsletter" description="Admin login for DevNewsletter — manage newsletters, posts, and categories">
    <h1 class="text-3xl font-bold mb-6">Admin Login — DevNewsletter</h1>

    <form id="loginForm" class="max-w-md" aria-labelledby="admin-login-form">
        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
        <input id="email" name="email" required type="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />

        <label for="password" class="block text-sm font-medium text-gray-700 mt-4">Password</label>
        <input id="password" name="password" required type="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />

        <button type="submit" class="w-full bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 mt-6">Login</button>
    </form>

    <script type="module">
        (function(){
            const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'https://devnewsletter-backend.onrender.com';
            const form = document.getElementById('loginForm');
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const emailEl = document.getElementById('email');
                const passwordEl = document.getElementById('password');
                const email = emailEl && 'value' in emailEl ? emailEl.value : '';
                const password = passwordEl && 'value' in passwordEl ? passwordEl.value : '';
                try {
                    const res = await fetch(`${API_BASE}/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    let dataText = '';
                    let data = null;
                    try {
                        dataText = await res.text();
                        try { data = JSON.parse(dataText); } catch(e){ data = null; }
                    } catch (e) { data = null; }

                    if (res.ok && data && data.token) {
                        localStorage.setItem('token', data.token);
                        console.debug('stored token', data.token.slice(0,20));
                        // set cookie as fallback for SSR checks
                        document.cookie = `token=${encodeURIComponent(data.token)}; path=/`;
                        window.location.href = '/admin';
                    } else {
                        console.error('Login failed', res.status, data || dataText);
                        alert((data && (data.error || data.message)) || dataText || `Login failed (status ${res.status})`);
                    }
                } catch (err) {
                    alert('Login failed');
                }
            });
        })();
    </script>
</Layout>