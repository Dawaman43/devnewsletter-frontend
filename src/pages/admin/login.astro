---
import Layout from "../../layouts/Layout.astro";
export const prerender = true;
---

<Layout>
    <h1 class="text-3xl font-bold mb-6">Admin Login</h1>

    <div class="max-w-md">
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="email" type="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />

        <label class="block text-sm font-medium text-gray-700 mt-4">Password</label>
        <input id="password" type="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />

        <button id="loginBtn" class="w-full bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 mt-6">Login</button>
    </div>

    <script>
        (function(){
            const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'https://devnewsletter-backend.onrender.com';
            const btn = document.getElementById('loginBtn');
            btn?.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = (document.getElementById('email') as HTMLInputElement).value;
                const password = (document.getElementById('password') as HTMLInputElement).value;
                try {
                    const res = await fetch(`${API_BASE}/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (res.ok && data.token) {
                        localStorage.setItem('token', data.token);
                        console.debug('stored token', data.token.slice(0,20));
                        // set cookie as fallback for SSR checks
                        document.cookie = `token=${encodeURIComponent(data.token)}; path=/`;
                        window.location.href = '/admin';
                    } else {
                        alert(data.error || 'Login failed');
                    }
                } catch (err) {
                    alert('Login failed');
                }
            });
        })();
    </script>
</Layout>