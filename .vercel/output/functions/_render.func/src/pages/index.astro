---
import Layout from '../layouts/Layout.astro';

const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:3000';
console.log('SSR fetch using API_BASE:', API_BASE);

let posts = [];
let topPosts = [];
let adminPicks = [];
let categories = [];

try {
  const [postsRes, topRes, adminRes, catsRes] = await Promise.all([
    fetch(`${API_BASE}/api/posts?limit=6`).catch(() => null),
    fetch(`${API_BASE}/api/posts/top?limit=4`).catch(() => null),
    fetch(`${API_BASE}/api/posts/admin-picks?limit=4`).catch(() => null),
    fetch(`${API_BASE}/api/categories`).catch(() => null)
  ]);
  
  if (postsRes?.ok) {
    const postsData = await postsRes.json();
    posts = postsData.posts || [];
  }
  
  if (topRes?.ok) {
    const topData = await topRes.json();
    topPosts = topData.posts || [];
  }
  
  if (adminRes?.ok) {
    const adminData = await adminRes.json();
    adminPicks = adminData.posts || [];
  }
  
  if (catsRes?.ok) {
    categories = await catsRes.json() || [];
  }
} catch (err) {
  console.error('Failed to load data:', err);
}

const formatExcerpt = (content) => {
  if (!content) return '';
  const text = content
    .replace(/!\[.*?\]\(.*?\)/g, '')
    .replace(/[#*`]/g, '')
    .replace(/\n+/g, ' ')
    .trim();
  return text.length > 0 ? text.substring(0, 150) + '...' : '';
};

const extractImage = (content) => {
  if (!content) return null;
  const match = content.match(/!\[.*?\]\((.*?)\)/);
  return match ? match[1] : null;
};
---

<Layout title="DevNewsletter - Stay Updated with Developer News" showHero={true}>
  
  <!-- Top Stories Section -->
  {topPosts.length > 0 && (
    <section class="top-stories-section py-20 bg-amber-50/20 dark:bg-amber-900/5">
      <div class="container">
        <div class="flex items-center gap-4 mb-12">
            <div class="w-12 h-12 flex items-center justify-center bg-amber-500 text-white rounded-2xl shadow-lg shadow-amber-500/20">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
            </div>
            <div>
                <h2 class="text-3xl md:text-4xl font-serif font-black leading-tight tracking-tight">Top Stories</h2>
                <p class="text-gray-500 dark:text-zinc-500 text-sm font-bold uppercase tracking-[0.2em] mt-1">Most Read This Week</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {topPosts.map(post => (
            <a href={`/posts/${post.id}`} class="group relative block aspect-[3/4] overflow-hidden rounded-3xl bg-gray-900 shadow-xl transition-all hover:-translate-y-2">
              <img 
                src={extractImage(post.content) || '/og-image.jpg'} 
                alt={post.title}
                class="absolute inset-0 h-full w-full object-cover opacity-60 transition-transform duration-700 group-hover:scale-110 group-hover:rotate-2"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
              <div class="absolute inset-0 p-6 flex flex-col justify-end gap-3 text-white">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-0.5 bg-amber-500 text-[10px] font-bold uppercase tracking-widest rounded-md">Trending</span>
                    <span class="text-[10px] text-gray-300 font-bold uppercase tracking-widest flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        {post.views}
                    </span>
                </div>
                <h3 class="text-xl font-serif font-bold group-hover:text-amber-400 transition-colors leading-snug">{post.title}</h3>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Categories -->
  {categories.length > 0 && (
    <section class="categories-section">
      <div class="container">
        <h2 class="section-title">Browse by Category</h2>
        <div class="categories-grid">
          {categories.map(cat => (
            <a href={`/categories/${cat.slug}`} class="category-card group">
              <span class="category-icon text-2xl group-hover:scale-125 transition-transform duration-300">üìÅ</span>
              <span class="category-name font-bold group-hover:text-amber-600 dark:group-hover:text-amber-500 transition-colors">{cat.name}</span>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Admin Picks Section -->
  {adminPicks.length > 0 && (
    <section class="admin-picks-section py-20 border-b border-gray-100 dark:border-zinc-800/50">
        <div class="max-w-xl mx-auto mb-16 space-y-4 text-center">
            <h2 class="text-4xl md:text-5xl font-serif font-black leading-tight">Admin Picks</h2>
            <p class="text-gray-500 dark:text-zinc-400 font-serif italic text-lg leading-relaxed">Hand-curated insights and stories you might have missed.</p>
            <div class="h-1 w-20 bg-amber-500 mx-auto rounded-full"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
          {adminPicks.map(post => (
            <article class="relative flex flex-col sm:flex-row gap-6 p-6 bg-gray-50 dark:bg-zinc-900/50 rounded-3xl border border-gray-100 dark:border-zinc-800/50 hover:bg-white dark:hover:bg-zinc-900 transition-all duration-300 text-left">
              <div class="shrink-0 w-full sm:w-40 h-32 overflow-hidden rounded-2xl border border-gray-100 dark:border-zinc-800">
                <img src={extractImage(post.content) || '/og-image.jpg'} alt={post.title} class="w-full h-full object-cover"/>
              </div>
              <div class="flex flex-col justify-center gap-3">
                <span class="text-[10px] font-bold text-amber-600 dark:text-amber-500 uppercase tracking-[0.2em]">Editor's Choice</span>
                <h3 class="text-xl font-serif font-bold leading-tight hover:text-amber-600 dark:hover:text-amber-500">
                  <a href={`/posts/${post.id}`}>{post.title}</a>
                </h3>
                <a href={`/posts/${post.id}`} class="text-xs font-bold uppercase tracking-widest text-gray-400 dark:text-zinc-500 hover:text-amber-600 transition-colors">Read Post &rarr;</a>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Latest Posts -->
  <section class="posts-section" id="latest">
    <div class="container">
      <div class="section-header flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-16">
        <div>
            <h2 class="text-4xl md:text-5xl font-serif font-black leading-tight">Latest Stories</h2>
            <p class="text-gray-500 dark:text-zinc-500 text-sm font-bold uppercase tracking-[0.2em] mt-2">The Freshly Brewed Notes</p>
        </div>
        <a href="/posts" class="view-all group flex items-center gap-3 px-8 py-3 bg-gray-900 dark:bg-white text-white dark:text-zinc-900 rounded-2xl font-black text-xs tracking-widest uppercase hover:scale-105 transition-all shadow-xl">
          <span>Explore All</span>
          <span class="group-hover:translate-x-1 transition-transform">&rarr;</span>
        </a>
      </div>
      
      {posts.length === 0 ? (
        <div class="empty-state">
          <p>No posts yet. Check back soon!</p>
        </div>
      ) : (
        <div class="posts-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {posts.map(post => (
            <article class="post-card group">
              <div class="post-card-content p-6 h-full flex flex-col">
                {extractImage(post.content) && (
                  <div class="post-image-container relative mb-8 aspect-[16/10] overflow-hidden rounded-2xl border border-gray-100 dark:border-zinc-800">
                    <img 
                      src={extractImage(post.content)} 
                      alt={post.title}
                      class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900/40 to-transparent"></div>
                  </div>
                )}
                
                <div class="flex items-center gap-3 mb-5">
                    <time class="text-[10px] font-bold text-gray-400 dark:text-zinc-500 uppercase tracking-widest">
                    {new Date(post.created_at).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    })}
                    </time>
                    <span class="w-1 h-1 bg-amber-500/30 rounded-full"></span>
                    <span class="text-[10px] font-bold text-amber-600 dark:text-amber-500 uppercase tracking-widest">Fresh Drop</span>
                </div>

                <h3 class="post-title text-2xl font-serif font-bold mb-4 leading-tight group-hover:text-amber-600 dark:group-hover:text-amber-500 transition-colors">
                  <a href={`/posts/${post.id}`}>{post.title}</a>
                </h3>

                <p class="post-excerpt text-gray-600 dark:text-zinc-400 font-serif leading-relaxed mb-10 line-clamp-3">
                  {formatExcerpt(post.content)}
                </p>

                <div class="mt-auto pt-6 border-t border-gray-100 dark:border-zinc-800/50">
                    <a href={`/posts/${post.id}`} class="read-more-btn inline-flex items-center gap-2 font-black text-[10px] text-gray-400 dark:text-zinc-500 tracking-widest uppercase hover:text-amber-600 dark:hover:text-amber-500 transition-all duration-300">
                        <span>Check it out</span>
                        <span class="text-amber-500">&rarr;</span>
                    </a>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  .container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Categories Section */
  .categories-section {
    padding: 6rem 0;
    background: var(--color-gray-50);
    border-bottom: 1px solid var(--color-gray-100);
  }
  
  :global(.dark) .categories-section {
    background: rgba(24, 24, 27, 0.4);
    border-bottom: 1px solid rgba(39, 39, 42, 0.5);
  }

  .section-title {
    font-size: 2.25rem;
    font-weight: 800;
    margin-bottom: 3.5rem;
    color: var(--text-heading);
    letter-spacing: -0.02em;
    font-family: var(--font-serif);
    text-align: center;
  }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .category-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 2rem;
    background: white;
    border-radius: 2rem;
    text-decoration: none;
    color: var(--text-main);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--color-gray-100);
    text-align: center;
  }

  .category-card:hover {
    border-color: var(--color-primary);
    transform: translateY(-8px);
    box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.1);
  }
  
  :global(.dark) .category-card {
    background: rgba(39, 39, 42, 0.6);
    border-color: rgba(63, 63, 70, 0.3);
  }
  
  :global(.dark) .category-card:hover {
    background: #27272a;
    box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.6);
  }

  .category-name {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* Posts Section */
  .posts-section {
    padding: 8rem 0;
  }

  .post-card {
    background: white;
    border-radius: 2.5rem;
    overflow: hidden;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--color-gray-100);
    height: 100%;
  }
  
  :global(.dark) .post-card {
    background: rgba(24, 24, 27, 0.6);
    border-color: rgba(39, 39, 42, 0.4);
  }

  .post-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 30px 60px -20px rgba(0, 0, 0, 0.15);
    border-color: var(--color-primary);
  }
  
  :global(.dark) .post-card:hover {
    box-shadow: 0 30px 60px -20px rgba(0, 0, 0, 0.6);
    background: #18181b;
  }

  .empty-state {
    text-align: center;
    padding: 8rem 2rem;
    color: var(--color-gray-500);
    background: var(--color-gray-50);
    border-radius: 3rem;
    border: 2px dashed var(--color-gray-200);
  }

  @media (max-width: 768px) {
    .container {
        padding: 0 1.25rem;
    }
    
    .categories-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
</style>
