---
import AdminLayout from "../../../../layouts/AdminLayout.astro";
export const prerender = false;

const API_BASE = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:3000';
const { id } = Astro.params;
---

<AdminLayout title="Post Preview">
  <div class="max-w-4xl mx-auto">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900">Post Preview</h1>
      <a href="/admin/posts" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
        Back to Posts
      </a>
    </div>

    <div id="loadingState" class="text-gray-500">Loading post...</div>

    <div id="previewContainer" class="hidden">
      <!-- Post metadata -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 id="postTitle" class="text-2xl font-bold text-gray-900"></h2>
          <span id="publishStatus" class="px-3 py-1 text-sm rounded"></span>
        </div>
        <div class="flex gap-4 text-sm text-gray-600">
          <div>Created: <span id="createdAt"></span></div>
          <div>Updated: <span id="updatedAt"></span></div>
        </div>
        <div id="categoriesContainer" class="mt-4"></div>
      </div>

      <!-- Rendered content -->
      <div class="bg-white rounded-lg shadow p-8">
        <article id="renderedContent" class="prose prose-lg max-w-none"></article>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

  <script define:vars={{ API_BASE, id }}>
    (async function(){
      const getToken = () => {
        try { const t = localStorage.getItem('token'); if (t) return t; } catch(e) {}
        const m = document.cookie.match(/(?:^|; )token=([^;]+)/);
        if (m) return decodeURIComponent(m[1]);
        return null;
      };

      const token = getToken();
      if (!token) return;

      // Load marked and highlight.js
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      await loadScript('https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js');
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js');

      try {
        // Load post
        const postRes = await fetch(`${API_BASE}/admin/posts`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const posts = await postRes.json();
        const post = posts.find(p => p.id === parseInt(id));

        if (!post) {
          document.getElementById('loadingState').textContent = 'Post not found';
          return;
        }

        // Load categories
        const catsRes = await fetch(`${API_BASE}/admin/posts/${id}/categories`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const categories = await catsRes.json();

        // Configure marked with syntax highlighting
        marked.setOptions({
          highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
              return hljs.highlight(code, { language: lang }).value;
            }
            return hljs.highlightAuto(code).value;
          },
          breaks: true,
          gfm: true
        });

        // Render content
        const html = marked.parse(post.content);
        document.getElementById('renderedContent').innerHTML = html;

        // Set metadata
        document.getElementById('postTitle').textContent = post.title;
        document.getElementById('createdAt').textContent = new Date(post.created_at).toLocaleString();
        document.getElementById('updatedAt').textContent = new Date(post.updated_at).toLocaleString();

        // Set publish status
        const statusEl = document.getElementById('publishStatus');
        if (post.published) {
          statusEl.textContent = 'Published';
          statusEl.className = 'px-3 py-1 text-sm rounded bg-green-100 text-green-800';
        } else {
          statusEl.textContent = 'Draft';
          statusEl.className = 'px-3 py-1 text-sm rounded bg-gray-100 text-gray-800';
        }

        // Set categories
        const catsContainer = document.getElementById('categoriesContainer');
        if (categories.length > 0) {
          catsContainer.innerHTML = '<div class="text-sm text-gray-600">Categories: ' +
            categories.map(cat => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded mr-2">${cat.name}</span>`).join('') +
            '</div>';
        }

        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('previewContainer').classList.remove('hidden');
      } catch (err) {
        console.error('Failed to load post', err);
        document.getElementById('loadingState').textContent = 'Failed to load post';
      }
    })();
  </script>

  <style>
    .prose {
      color: #1f2937;
    }
    .prose h1 {
      font-size: 2.25em;
      margin-top: 0;
      margin-bottom: 0.8888889em;
      line-height: 1.1111111;
      font-weight: 800;
    }
    .prose h2 {
      font-size: 1.5em;
      margin-top: 2em;
      margin-bottom: 1em;
      line-height: 1.3333333;
      font-weight: 700;
    }
    .prose h3 {
      font-size: 1.25em;
      margin-top: 1.6em;
      margin-bottom: 0.6em;
      line-height: 1.6;
      font-weight: 600;
    }
    .prose p {
      margin-top: 1.25em;
      margin-bottom: 1.25em;
      line-height: 1.75;
    }
    .prose pre {
      background-color: #1f2937;
      border-radius: 0.5rem;
      padding: 1rem;
      overflow-x: auto;
      margin: 1.5em 0;
    }
    .prose code {
      background-color: #f3f4f6;
      padding: 0.2em 0.4em;
      border-radius: 0.25rem;
      font-size: 0.875em;
    }
    .prose pre code {
      background-color: transparent;
      padding: 0;
    }
    .prose ul, .prose ol {
      margin-top: 1.25em;
      margin-bottom: 1.25em;
      padding-left: 1.625em;
    }
    .prose li {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    .prose blockquote {
      font-style: italic;
      border-left: 4px solid #e5e7eb;
      padding-left: 1em;
      margin: 1.5em 0;
      color: #6b7280;
    }
    .prose a {
      color: #3b82f6;
      text-decoration: underline;
    }
    .prose img {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      margin: 1.5em 0;
    }
    .prose table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5em 0;
    }
    .prose th, .prose td {
      border: 1px solid #e5e7eb;
      padding: 0.75em;
      text-align: left;
    }
    .prose th {
      background-color: #f9fafb;
      font-weight: 600;
    }
  </style>
</AdminLayout>
